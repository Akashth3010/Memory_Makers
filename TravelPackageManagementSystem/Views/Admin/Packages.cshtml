@{
    ViewData["Title"] = "Packages";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page packages-page">
    <div class="packages-header">
        <div>
            <h2 class="page-heading">Packages Management</h2>
            <p class="page-subtext">Manage travel packages, image galleries, and daily itineraries</p>
        </div>
        <button class="btn-add" onclick="openAddModal()">+ Add New Package</button>
    </div>

    <div class="package-filters">
        <input type="text" id="searchBox" placeholder="Search by name..." />
        <select id="typeFilter">
            <option value="">All Types</option>
            <option>Family</option>
            <option>Honeymoon</option>
            <option>Friends</option>
            <option>Solo</option>
        </select>
        <select id="statusFilter">
            <option value="">All Status</option>
            <option>Active</option>
            <option>Inactive</option>
        </select>
    </div>

    <div class="packages-grid" id="packagesGrid"></div>
</div>

<div class="custom-modal" id="addModal">
    <div class="modal-box detailed-modal">
        <div class="modal-header-custom">
            <h4 id="modalTitle">Add Package</h4>
            <button class="close-modal-btn" onclick="closeModal()">×</button>
        </div>

        <div class="modal-body-scroll">
            <input type="hidden" id="pId" />

            <div class="form-section-admin">
                <h5><i class="fa fa-info-circle"></i> Basic Information</h5>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Package Name</label>
                        <input id="pName" placeholder="e.g. Luxury Kerala" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Destination</label>
                        <input id="pDest" placeholder="e.g. Munnar" />
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Destination ID (SQL)</label>
                        <input id="pDestId" type="number" placeholder="ID" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Location / Region</label>
                        <input id="pLocation" placeholder="e.g. South India" />
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Package Type</label>
                        <input id="pType" placeholder="e.g. Honeymoon" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Duration</label>
                        <input id="pDuration" placeholder="e.g. 4 Days" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Price (₹)</label>
                        <input id="pPrice" type="number" placeholder="Amount" />
                    </div>
                </div>
                <div class="form-col mt-2">
                    <label class="info-label-blue">Brief Description</label>
                    <textarea id="pDesc" rows="2" placeholder="Summary for cards..."></textarea>
                </div>
            </div>

            <div class="form-section-admin">
                <h5><i class="fa fa-images"></i> Image Gallery & Thumbnails</h5>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Main Hero Image URL</label>
                        <input id="pImgUrl" placeholder="https://..." />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Thumbnail 1 URL</label>
                        <input id="pThumb1" placeholder="Thumbnail 1" />
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Thumbnail 2 URL</label>
                        <input id="pThumb2" placeholder="Thumbnail 2" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Thumbnail 3 URL</label>
                        <input id="pThumb3" placeholder="Thumbnail 3" />
                    </div>
                </div>
            </div>

            <div class="form-section-admin">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0"><i class="fa fa-route"></i> Day-by-Day Itinerary</h5>
                    <button type="button" class="btn-add-day" onclick="addDayRow()">+ Add Day</button>
                </div>
                <div id="itineraryContainerAdmin"></div>
            </div>
        </div>

        <div class="modal-actions-custom">
            <button class="btn-cancel-admin" onclick="closeModal()">Cancel</button>
            <button class="btn-save-admin" onclick="savePackage()">Save Everything</button>
        </div>
    </div>
</div>

<div class="confirm-overlay" id="deleteConfirmBox">
    <div class="confirm-box">
        <i class="fa fa-exclamation-triangle" style="color: #e74c3c;"></i>
        <h4>Delete Package?</h4>
        <p>Are you sure you want to delete this package? This action cannot be undone.</p>
        <div class="confirm-btns">
            <button class="no-btn" onclick="hideDeleteConfirm()">No, Keep it</button>
            <button class="yes-btn" id="confirmDeleteBtn" style="background: #e74c3c;">Yes, Delete</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let packages = [];
    let packageToDeleteId = null;

    function loadPackages() {
        $.get("/Admin/GetPackages", function (data) {
            packages = data;
            renderPackages();
        });
    }

    function renderPackages() {
        let grid = $("#packagesGrid");
        grid.html("");
        let search = $("#searchBox").val()?.toLowerCase();
        let type = $("#typeFilter").val();
        let status = $("#statusFilter").val();

        let filtered = packages.filter(p =>
            (!search || p.name.toLowerCase().includes(search)) &&
            (!type || p.type === type) &&
            (!status || p.status === status)
        );

        if (filtered.length === 0) {
            grid.html("<div class='no-data-msg'>No packages found. Try adjusting filters.</div>");
            return;
        }

        filtered.forEach(p => {
            grid.append(`
                <div class="package-card">
                    <span class="pkg-badge">${p.category}</span>
                    <h4>${p.name}</h4>
                    <p class="pkg-dest">${p.dest} • ${p.type}</p>
                    <p class="pkg-meta"><b>${p.duration}</b> | <b>₹${p.price}</b></p>
                    <p class="pkg-status ${p.status.toLowerCase()}">${p.status}</p>
                    <div class="pkg-actions">
                         <button class="btn-edit" onclick="editPackage(${p.id})"><i class="fa fa-edit"></i> Edit</button>
                         <button class="btn-delete" onclick="prepareDelete(${p.id})"><i class="fa fa-trash"></i> Delete</button>
                    </div>
                </div>
            `);
        });
    }

    function addDayRow(data = null) {
        let dayNum = $("#itineraryContainerAdmin .itinerary-day-box").length + 1;
        let html = `
            <div class="itinerary-day-box">
                <div class="day-header-admin">
                    <span>Day ${dayNum}</span>
                    <button type="button" class="btn-remove-day" onclick="$(this).closest('.itinerary-day-box').remove(); reorderDays();">×</button>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Title</label>
                        <input class="it-title" placeholder="Day Title" value="${data ? data.title : ''}" />
                    </div>
                </div>
                <div class="form-col mb-3">
                    <label class="info-label-blue">Description</label>
                    <textarea class="it-desc" placeholder="Activities...">${data ? data.desc : ''}</textarea>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Inclusions</label>
                        <input class="it-inc" placeholder="Split by ;" value="${data ? data.inclusions : ''}" />
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Exclusions</label>
                        <input class="it-exc" placeholder="Split by ;" value="${data ? data.exclusions : ''}" />
                    </div>
                </div>
            </div>`;
        $("#itineraryContainerAdmin").append(html);
    }

    function reorderDays() {
        $("#itineraryContainerAdmin .day-header-admin span").each(function(i) {
            $(this).text("Day " + (i + 1));
        });
    }

    function openAddModal() {
        $("#modalTitle").text("Add New Package");
        $("#pId").val("");
        $("#itineraryContainerAdmin").html("");
        $("#addModal input, #addModal textarea").val("");
        addDayRow();
        $("#addModal").addClass("show");
    }

    function editPackage(id) {
        $.get("/Admin/GetPackageById/" + id, function(data) {
            $("#modalTitle").text("Edit Package Details");
            $("#pId").val(data.id);
            $("#pName").val(data.name);
            $("#pDest").val(data.dest);
            $("#pDestId").val(data.destId);
            $("#pLocation").val(data.location);
            $("#pType").val(data.type);
            $("#pDuration").val(data.duration);
            $("#pPrice").val(data.price);
            $("#pDesc").val(data.description);
            $("#pImgUrl").val(data.imgUrl);
            $("#pThumb1").val(data.thumb1);
            $("#pThumb2").val(data.thumb2);
            $("#pThumb3").val(data.thumb3);

            $("#itineraryContainerAdmin").html("");
            if(data.itineraries && data.itineraries.length > 0) {
                data.itineraries.forEach(it => addDayRow(it));
            } else {
                addDayRow();
            }

            $("#addModal").addClass("show");
        });
    }

    function closeModal() {
        $("#addModal").removeClass("show");
    }

    function savePackage() {
        let id = $("#pId").val();

        let itins = [];
        $("#itineraryContainerAdmin .itinerary-day-box").each(function(i) {
            itins.push({
                dayNumber: i + 1,
                title: $(this).find(".it-title").val(),
                desc: $(this).find(".it-desc").val(),
                inclusions: $(this).find(".it-inc").val(),
                exclusions: $(this).find(".it-exc").val()
            });
        });

        let data = {
            name: $("#pName").val(),
            dest: $("#pDest").val(),
            destId: parseInt($("#pDestId").val()) || null,
            type: $("#pType").val(),
            duration: $("#pDuration").val(),
            price: parseFloat($("#pPrice").val()),
            description: $("#pDesc").val(),
            location: $("#pLocation").val(),
            imgUrl: $("#pImgUrl").val(),
            thumb1: $("#pThumb1").val(),
            thumb2: $("#pThumb2").val(),
            thumb3: $("#pThumb3").val(),
            itineraries: itins
        };

        let url = id ? "/Admin/UpdatePackage?id=" + id : "/Admin/AddPackage";

        $.ajax({
            url: url,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (res) {
                closeModal();
                loadPackages();
            },
            error: function (err) {
                alert("Error saving package. Ensure all required fields are filled.");
            }
        });
    }

    // --- DELETE WITH CONFIRMATION ---
    function prepareDelete(id) {
        packageToDeleteId = id;
        $("#deleteConfirmBox").css("display", "flex");

        $("#confirmDeleteBtn").off("click").on("click", function() {
            hideDeleteConfirm();
            executeDelete(packageToDeleteId);
        });
    }

    function hideDeleteConfirm() { $("#deleteConfirmBox").hide(); }

    function executeDelete(id) {
        let pwd = prompt("🔐 Authorized Access Only: Enter Admin Password:");
        if (!pwd) return;

        $.post("/Admin/DeletePackage", { id: id, password: pwd }, function (res) {
            if (res.success) {
                loadPackages();
            } else {
                alert(res.message);
            }
        });
    }

    $("#searchBox, #typeFilter, #statusFilter").on("input change", renderPackages);
    $(document).ready(loadPackages);
</script>