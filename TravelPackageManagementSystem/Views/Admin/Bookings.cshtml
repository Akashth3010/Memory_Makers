@{
    ViewData["Title"] = "Bookings";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page bookings-page">

    <h2 class="page-heading">Bookings Management</h2>
    <p class="page-subtext">
        Review, confirm and manage all customer bookings
    </p>

    <div class="booking-tabs">
        <div class="btab active" data-status="Pending Confirmation">Pending Confirmation</div>
        <div class="btab" data-status="Confirmed">Confirmed</div>
        <div class="btab" data-status="Completed">Completed</div>
        <div class="btab" data-status="Cancelled">Cancelled</div>
    </div>

    <div class="booking-filters">
        <input type="text" id="searchBox" placeholder="Search by Booking ID / Customer / Package" />
    </div>

    <div id="bookingGrid" class="booking-grid">
    </div>

    <div class="custom-modal" id="bookingModal">
        <div class="modal-box large-modal">
            <h4>Booking Details</h4>
            <div class="details-grid">
                <div><b>Booking ID:</b> <span id="bId"></span></div>
                <div><b>Status:</b> <span id="bStatus"></span></div>
                <div><b>Customer:</b> <span id="bCustomer"></span></div>
                <div><b>Phone:</b> <span id="bPhone"></span></div>
                <div><b>Package:</b> <span id="bPackage"></span></div>
                <div><b>Destination:</b> <span id="bDest"></span></div>
                <div><b>Duration:</b> <span id="bDuration"></span></div>
                <div><b>Travelers:</b> <span id="bPeople"></span></div>
                <div><b>Amount Paid:</b> ₹<span id="bAmount"></span></div>
                <div><b>Payment:</b> <span class="paid-text">Paid</span></div>
            </div>

            <div class="modal-actions">
                <button class="btn-confirm-booking" id="completeBtn" style="display:none;">Mark as Completed</button>

                <button class="btn-confirm-booking" id="confirmBtn">Confirm Booking</button>
                <button class="btn-reject" id="cancelBtn">Cancel & Refund</button>
                <button class="btn-cancel" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let bookings = [];
    let currentStatus = "Pending Confirmation";
    let selectedBooking = null;

    // --- 1. FETCH DATA ---
    function fetchBookings() {
        $("#bookingGrid").html('<p class="loading-text">Loading bookings...</p>');

        $.ajax({
            url: '/Admin/GetAllBookings',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                bookings = data;
                renderBookings();
            },
            error: function (xhr, status, error) {
                console.error("Fetch Error:", error);
                $("#bookingGrid").html('<p class="error-text">Failed to load bookings from server.</p>');
            }
        });
    }

    // --- 2. RENDER THE GRID ---
    function renderBookings() {
        let grid = $("#bookingGrid").html("");
        let search = $("#searchBox").val()?.toLowerCase();

        let filtered = bookings.filter(b =>
            b.status === currentStatus &&
            (!search ||
             b.customer.toLowerCase().includes(search) ||
             b.pkg.toLowerCase().includes(search) ||
             b.id.toLowerCase().includes(search))
        );

        if (filtered.length === 0) {
            grid.html(`<p class="empty-text">No ${currentStatus} bookings found</p>`);
            return;
        }

        filtered.forEach(b => {
            grid.append(`
                <div class="booking-card glow-card">
                    <div class="booking-top">
                        <span class="booking-id">${b.id}</span>
                        <span class="status-badge ${b.status.replace(/\s+/g, '-').toLowerCase()}">${b.status}</span>
                    </div>
                    <h4>${b.customer}</h4>
                    <p>${b.pkg} • ${b.dest}</p>
                    <div class="booking-info">
                        <span>₹${b.amount.toLocaleString()}</span>
                        <span>${b.people} Travelers</span>
                    </div>
                    <button class="btn-action" onclick="viewBooking('${b.id}')">View & Take Action</button>
                </div>
            `);
        });
    }

    // --- 3. MODAL ACTIONS ---
    function viewBooking(id) {
        selectedBooking = bookings.find(b => b.id === id);
        if(!selectedBooking) return;

        $("#bId").text(selectedBooking.id);
        $("#bStatus").text(selectedBooking.status);
        $("#bCustomer").text(selectedBooking.customer);
        $("#bPhone").text(selectedBooking.phone);
        $("#bPackage").text(selectedBooking.pkg);
        $("#bDest").text(selectedBooking.dest);
        $("#bDuration").text(selectedBooking.duration);
        $("#bPeople").text(selectedBooking.people);
        $("#bAmount").text(selectedBooking.amount.toLocaleString());

        // --- BUTTON VISIBILITY ---
        // Confirm: PENDING ONLY
        $("#confirmBtn").toggle(selectedBooking.status === "Pending Confirmation");

        // Complete: CONFIRMED ONLY
        $("#completeBtn").toggle(selectedBooking.status === "Confirmed");

        // Cancel: PENDING OR CONFIRMED
        $("#cancelBtn").toggle(selectedBooking.status !== "Cancelled" && selectedBooking.status !== "Completed");

        $("#bookingModal").addClass("show");
    }

    function closeModal() {
        $("#bookingModal").removeClass("show");
    }

    // --- 4. UPDATE STATUS ---
    function updateStatus(newStatus, successMessage) {
        if (!selectedBooking) return;

        $.ajax({
            url: '/Admin/UpdateBookingStatus',
            type: 'POST',
            data: {
                bookingId: selectedBooking.id,
                status: newStatus
            },
            success: function (response) {
                selectedBooking.status = newStatus;
                closeModal();
                renderBookings();
                alert(successMessage);
            },
            error: function () {
                alert("Error: Could not update the booking status on the server.");
            }
        });
    }

    // --- 5. INITIALIZATION ---
    $(document).ready(function () {
        fetchBookings();

        $(".btab").click(function () {
            $(".btab").removeClass("active");
            $(this).addClass("active");
            currentStatus = $(this).data("status");
            renderBookings();
        });

        $("#searchBox").on("input", renderBookings);

        $("#confirmBtn").click(function () {
            updateStatus("Confirmed", "Booking confirmed successfully!");
        });

        $("#completeBtn").click(function () {
            updateStatus("Completed", "Trip marked as Completed!");
        });

        $("#cancelBtn").click(function () {
            if(confirm("Are you sure you want to cancel this booking?")) {
                updateStatus("Cancelled", "Booking has been cancelled.");
            }
        });
    });
</script>