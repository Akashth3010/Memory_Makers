@{
    ViewData["Title"] = "Users";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page users-page">

    <h2 class="page-heading">User Management</h2>
    <p class="page-subtitle">Manage customers and travel hosts on the platform</p>

    <!-- STATS -->
    <div class="stats-grid">
        <div class="stat-card glow">
            <h4>Total Users</h4>
            @* Sum of Customers and unique Hosts *@
            <p id="totalUsers">@((ViewBag.Customers?.Count ?? 0) + (ViewBag.Hosts?.Count ?? 0))</p>
        </div>
        <div class="stat-card glow">
            <h4>Customers</h4>
            <p>@(ViewBag.Customers?.Count ?? 0)</p>
        </div>
        <div class="stat-card glow">
            <h4>Travel Hosts</h4>
            @* This will now show 1 if the same host registered twice *@
            <p>@(ViewBag.Hosts?.Count ?? 0)</p>
        </div>
    </div>

    <!-- TABS -->
    <div class="user-tabs">
        <button class="tab-btn active" data-tab="customers">Customers</button>
        <button class="tab-btn" data-tab="hosts">Travel Hosts</button>
    </div>

    <!-- FILTER -->
    <div class="user-filter">
        <select id="statusFilter">
            <option value="all">All Status</option>
        </select>
    </div>

    <!-- CUSTOMERS -->
    <div class="user-table tab-content active" id="customers">

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                </tr>
            </thead>
            <tbody id="customerBody">
                @foreach (var user in ViewBag.Customers)
                {
                    <tr class="hover-glow" data-status="active">
                        <td>@user.Username</td>
                        <td>@user.Email</td>
                        <td>@(string.IsNullOrEmpty(user.PhoneNumber) ? "N/A" : user.PhoneNumber)</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- HOSTS -->
    <div class="user-table tab-content" id="hosts">
        <table>
            <thead>
                <tr>
                    <th>Agency</th>
                    <th>Email</th>
                    <th>Packages</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var host in ViewBag.Hosts)
                {
                    <tr class="hover-glow">
                        <td>@host.HostAgencyName</td>
                        <td>@host.EmailAddress</td>
                        <td>
                            @if (host.PackageNames != null && host.PackageNames.Count > 0)
                            {
                                @string.Join(", ", host.PackageNames)
                            }
                            else
                            {
                                <span>No Packages</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>

<!-- USER MODAL -->
<div class="custom-modal" id="userModal">
    <div class="modal-box">
        <h4 id="userName"></h4>
        <p><b>Email:</b> <span id="userEmail"></span></p>
        <p><b>Phone:</b> <span id="userPhone"></span></p>
        <p><b>Role:</b> <span id="userRole"></span></p>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeUserModal()">Close</button>
        </div>
    </div>
</div>

<script>
    let blockedCount = 2;

    // TAB SWITCH
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.onclick = function () {
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

            this.classList.add("active");
            document.getElementById(this.dataset.tab).classList.add("active");

            loadFilterOptions(this.dataset.tab);
        };
    });

    // FILTER OPTIONS
    function loadFilterOptions(tab) {
        const filter = document.getElementById("statusFilter");
        filter.innerHTML = `<option value="all">All Status</option>`;

        if (tab === "customers") {
            filter.innerHTML += `
                <option value="active">Active</option>
                <option value="blocked">Blocked</option>`;
        } else {
            filter.innerHTML += `
                <option value="approved">Approved</option>
                <option value="pending">Pending</option>
                <option value="blocked">Blocked</option>`;
        }
    }

    loadFilterOptions("customers");

    document.getElementById("statusFilter").onchange = function () {
        document.querySelectorAll(".tab-content.active tbody tr").forEach(row => {
            row.style.display =
                this.value === "all" || row.dataset.status === this.value
                    ? ""
                    : "none";
        });
    };

</script>