@{
    ViewData["Title"] = "Approvals";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page approvals-page">
    <div class="packages-header">
        <div>
            <h2 class="page-heading">Package Approvals</h2>
            <p class="page-subtext">Review host submitted travel packages and take action</p>
        </div>
    </div>

    <div class="approval-tabs">
        <div class="tab active" data-status="pending">Pending</div>
        <div class="tab" data-status="approved">Approved</div>
        <div class="tab" data-status="rejected">Rejected</div>
    </div>

    <div id="approvalList" class="approval-grid"></div>
</div>

<div class="custom-modal" id="approvalModal">
    <div class="modal-box detailed-modal">
        <div class="modal-header-custom">
            <h4><i class="fa fa-file-invoice"></i> Submission Summary</h4>
            <button class="close-modal-btn" onclick="closeModal()">×</button>
        </div>

        <div class="modal-body-scroll">
            <div class="form-section-admin">
                <h5 class="section-subtitle"><i class="fa fa-user-circle"></i> Host Information</h5>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Agency Name</label>
                        <div class="read-only-text" id="dHost"></div>
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Email Address</label>
                        <div class="read-only-text" id="dEmail"></div>
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Phone Number</label>
                        <div class="read-only-text" id="dPhone"></div>
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Registered Location</label>
                        <div class="read-only-text" id="dCity"></div>
                    </div>
                </div>
            </div>

            <div class="form-section-admin">
                <h5 class="section-subtitle"><i class="fa fa-map-marked-alt"></i> Package Details</h5>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Package Name</label>
                        <div class="read-only-text" id="dPackage"></div>
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Primary Destination</label>
                        <div class="read-only-text" id="dDestination"></div>
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="form-col">
                        <label class="info-label-blue">Category / Type</label>
                        <div class="read-only-text" id="dType"></div>
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Trip Duration</label>
                        <div class="read-only-text" id="dDuration"></div>
                    </div>
                    <div class="form-col">
                        <label class="info-label-blue">Price per Person</label>
                        <div class="read-only-text">₹<span id="dPrice"></span></div>
                    </div>
                </div>
                <label class="info-label-blue">Detailed Overview</label>
                <div class="read-only-text desc-area" id="dDesc"></div>
            </div>

            <div class="form-section-admin">
                <h5 class="section-subtitle"><i class="fa fa-camera-retro"></i> Image Gallery</h5>
                <div id="dThumbnails" class="thumbnail-display-grid"></div>
            </div>

            <div class="form-section-admin">
                <h5 class="section-subtitle"><i class="fa fa-list-ol"></i> Planned Itinerary</h5>
                <div id="dItinerary" class="itinerary-list-view"></div>
            </div>
        </div>

        <div class="modal-actions-custom">
            <button class="btn-cancel-admin" onclick="closeModal()">Close</button>
            <button class="btn-reject-admin" onclick="confirmAction('Rejected')">Reject Submission</button>
            <button class="btn-approve-admin" onclick="confirmAction('Approved')">Approve & Publish</button>
        </div>
    </div>
</div>

<div class="confirm-overlay" id="confirmBox">
    <div class="confirm-box">
        <i class="fa fa-question-circle"></i>
        <h4>Are you sure?</h4>
        <p id="confirmMsg">Do you want to proceed with this action?</p>
        <div class="confirm-btns">
            <button class="no-btn" onclick="hideConfirm()">No, Cancel</button>
            <button class="yes-btn" id="confirmYesBtn">Yes, Proceed</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let currentStatus = "pending";
    let selectedId = null;
    let pendingAction = null;

    $(document).ready(function () {
        renderList();
        $(".tab").click(function () {
            $(".tab").removeClass("active");
            $(this).addClass("active");
            currentStatus = $(this).data("status");
            renderList();
        });
    });

    function renderList() {
        $("#approvalList").html("<p class='empty-text'>Loading requests...</p>");
        $.get(`/Admin/GetApprovals?status=${currentStatus}`, function (data) {
            $("#approvalList").html("");
            if (data.length === 0) {
                $("#approvalList").html(`<p class="empty-text">No ${currentStatus} requests found.</p>`);
                return;
            }
            data.forEach(a => {
                $("#approvalList").append(`
                    <div class="approval-card glow-card">
                        <div class="pkg-badge-pending">NEW SUBMISSION</div>
                        <h5>${a.package}</h5>
                        <p><b>Agency:</b> ${a.host}</p>
                        <p><b>Region:</b> ${a.destination}</p>
                        <button class="view-btn-admin" onclick='fetchAndShowDetails(${a.id})'>Review Details</button>
                    </div>
                `);
            });
        });
    }

    function fetchAndShowDetails(id) {
        selectedId = id;
        $.get(`/Admin/GetPackageById/${id}`, function(data) {
            $("#dHost").text(data.host || "Agency Host");
            $("#dEmail").text(data.email || "Contact Host for email");
            $("#dPhone").text(data.phone || "Contact Host for phone");
            $("#dCity").text(data.location || "Not Provided");
            $("#dPackage").text(data.name);
            $("#dDestination").text(data.dest);
            $("#dType").text(data.type);
            $("#dDuration").text(data.duration);
            $("#dPrice").text(data.price);
            $("#dDesc").text(data.description);

            let thumbs = "";
            if(data.imgUrl) thumbs += `<img src="${data.imgUrl}" class="admin-preview-img">`;
            if(data.thumb1) thumbs += `<img src="${data.thumb1}" class="admin-preview-img">`;
            if(data.thumb2) thumbs += `<img src="${data.thumb2}" class="admin-preview-img">`;
            $("#dThumbnails").html(thumbs || "No photos provided.");

            let itHtml = "";
            if(data.itineraries && data.itineraries.length > 0) {
                data.itineraries.forEach(i => {
                    itHtml += `
                        <div class="itinerary-desc-item">
                            <span class="day-indicator">Day ${i.dayNumber}</span>
                            <h6>${i.title}</h6>
                            <p>${i.desc}</p>
                        </div>`;
                });
            } else { itHtml = "<p class='empty-text'>No itinerary provided.</p>"; }
            $("#dItinerary").html(itHtml);

            $("#approvalModal").addClass("show");
        });
    }

    function confirmAction(status) {
        pendingAction = status;
        $("#confirmMsg").text(`Do you want to mark this package as ${status}?`);
        $("#confirmBox").css("display", "flex");

        $("#confirmYesBtn").off("click").on("click", function() {
            updateStatus(pendingAction);
            hideConfirm();
        });
    }

    function hideConfirm() { $("#confirmBox").hide(); }
    function closeModal() { $("#approvalModal").removeClass("show"); }

    function updateStatus(newStatus) {
        $.post('/Admin/UpdateStatus', { id: selectedId, status: newStatus }, function (res) {
            if (res.success) {
                closeModal();
                renderList();
            }
        });
    }
</script>