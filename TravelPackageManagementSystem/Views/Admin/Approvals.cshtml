@{
    ViewData["Title"] = "Approvals";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-page approvals-page">

    <h2 class="page-heading">Package Approvals</h2>
    <p class="page-subtext">
        Review host submitted travel packages and take action
    </p>

    <!-- ================= STATUS TABS ================= -->
    <div class="approval-tabs">
        <div class="tab active" data-status="pending">Pending</div>
        <div class="tab" data-status="approved">Approved</div>
        <div class="tab" data-status="rejected">Rejected</div>
    </div>

    <!-- ================= LIST ================= -->
    <div id="approvalList" class="approval-grid"></div>

    <!-- ================= DETAILS PANEL ================= -->
    <div id="approvalDetails" class="approval-details">

        <h4>Host Package Details</h4>

        <div class="details-grid">
            <div><b>Host Name:</b> <span id="dHost"></span></div>
            <div><b>Email:</b> <span id="dEmail"></span></div>
            <div><b>Phone:</b> <span id="dPhone"></span></div>
            <div><b>City:</b> <span id="dCity"></span></div>

            <div><b>Package Name:</b> <span id="dPackage"></span></div>
            <div><b>Destination:</b> <span id="dDestination"></span></div>
            <div><b>Package Type:</b> <span id="dType"></span></div>
            <div><b>Duration:</b> <span id="dDuration"></span></div>
            <div><b>Price:</b> ₹<span id="dPrice"></span></div>
        </div>

        <div class="desc-box">
            <b>Description</b>
            <p id="dDesc"></p>
        </div>

        <div class="details-actions">
            <button class="btn-approve">Accept</button>
            <button class="btn-reject">Reject</button>
            <button class="btn-close">Close</button>
        </div>

    </div>

</div>

<!-- ================= jQuery ================= -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    let currentStatus = "pending";
    let selectedId = null;

    $(document).ready(function () {
        // Load the initial list from the database
        renderList();

        // Handle Tab switching (Pending, Approved, Rejected)
        $(".tab").click(function () {
            $(".tab").removeClass("active");
            $(this).addClass("active");
            currentStatus = $(this).data("status");
            renderList();
        });

        // Set up action buttons
        $(".btn-approve").click(() => updateStatus("Approved"));
        $(".btn-reject").click(() => updateStatus("Rejected"));
        $(".btn-close").click(() => $("#approvalDetails").fadeOut());
    });

    // FETCH LIVE DATA FROM THE CONTROLLER
    function renderList() {
        $("#approvalList").html("<p class='loading-text'>Fetching requests from database...</p>");

        // Calls the GetApprovals method in AdminController.cs
        $.get(`/Admin/GetApprovals?status=${currentStatus}`, function (data) {
            $("#approvalList").html("");

            if (data.length === 0) {
                $("#approvalList").html(`<p class="empty-text">No ${currentStatus} requests found.</p>`);
                return;
            }

            data.forEach(a => {
                $("#approvalList").append(`
                    <div class="approval-card glow-card">
                        <h5>${a.package}</h5>
                        <p><b>Host:</b> ${a.host}</p>
                        <p><b>Type:</b> ${a.type}</p>
                        <button onclick='viewDetails(${JSON.stringify(a)})'>View Details</button>
                    </div>
                `);
            });
        });
    }

    function viewDetails(data) {
        selectedId = data.id;

        // Populate the details panel with real database values
        $("#dHost").text(data.host);
        $("#dEmail").text(data.email);
        $("#dPhone").text(data.phone);
        $("#dCity").text(data.city);
        $("#dPackage").text(data.package);
        $("#dDestination").text(data.destination);
        $("#dType").text(data.type);
        $("#dDuration").text(data.duration);
        $("#dPrice").text(data.price);
        $("#dDesc").text(data.desc);

        $("#approvalDetails").fadeIn();
    }

    // UPDATE DATABASE STATUS (Accept/Reject)
    function updateStatus(newStatus) {
        $.post('/Admin/UpdateStatus', { id: selectedId, status: newStatus }, function (res) {
            if (res.success) {
                $("#approvalDetails").fadeOut();
                renderList(); // Refresh list to move item to the new tab
            } else {
                alert("Error updating status: " + res.message);
            }
        });
    }
</script>