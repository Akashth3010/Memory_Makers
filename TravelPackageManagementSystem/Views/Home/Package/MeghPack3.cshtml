@model TravelPackageManagementSystem.Repository.Models.TravelPackage

@{
	ViewBag.Title = Model.PackageName;
	Layout = "_Layout";
}
<link rel="stylesheet" href="~/css/MeghPack.css" asp-append-version="true" />
<style>
	.hero-section {
		height: 180px;
		background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('@Model.ImageUrl');
		background-size: cover;
		background-position: center;
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		margin-bottom: 30px;
		border-radius: 0 0 20px 20px;
	}
</style>

<div class="hero-section shadow">
	<div class="text-center">
		@if (!string.IsNullOrEmpty(Model.PackageType))
		{
			<div class="mb-3">
				<span class="badge rounded-pill bg-light text-primary px-3 py-2 shadow-sm"
					  style="font-size: 0.85rem; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 700;">
					<i class="fas fa-tag me-1"></i> @Model.PackageType
				</span>
			</div>
		}
		<h2 class="display-6 fw-bold">@Model.PackageName</h2>
		<p class="fs-5">@Model.Duration | @Model.Location</p>
	</div>
</div>

<div class="container pb-5">
	<div class="row g-4">
		<div class="col-lg-8">
			<div class="mb-4">
				<img id="mainDisplay" src="@Model.ImageUrl" class="rounded-4 shadow-sm w-100" style="height: 400px; object-fit: cover;">
			</div>

			<div class="d-flex gap-2 mb-4">
				<img src="@Model.ImageUrl" class="thumb-nail active" onclick="swap(this)">
				@if (!string.IsNullOrEmpty(Model.ThumbnailUrl1))
				{
					<img src="@Model.ThumbnailUrl1" class="thumb-nail" onclick="swap(this)">
				}
				@if (!string.IsNullOrEmpty(Model.ThumbnailUrl2))
				{
					<img src="@Model.ThumbnailUrl2" class="thumb-nail" onclick="swap(this)">
				}
			</div>

			<h4 class="fw-bold mb-3">Trip Itinerary</h4>
			<div class="accordion border rounded-3 mb-4" id="itineraryAcc">
				@if (Model.Itineraries != null)
				{
					@foreach (var day in Model.Itineraries.OrderBy(d => d.DayNumber))
					{
						<div class="accordion-item">
							<h2 class="accordion-header">
								<button class="accordion-button collapsed py-2 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#day-@day.DayNumber">
									Day @day.DayNumber — @day.ActivityTitle
								</button>
							</h2>
							<div id="day-@day.DayNumber" class="accordion-collapse collapse" data-bs-parent="#itineraryAcc">
								<div class="accordion-body text-muted small">@day.ActivityDescription</div>
							</div>
						</div>
					}
				}
			</div>

			@{
				var fDay = Model.Itineraries?.OrderBy(d => d.DayNumber).FirstOrDefault();
			}
			<div class="row bg-light rounded-3 p-3 g-3">
				<div class="col-md-6 border-end">
					<span class="fw-bold text-success small">✓ INCLUSIONS</span>
					<ul class="list-unstyled small mt-2 mb-0 text-muted">
						@if (fDay != null && !string.IsNullOrEmpty(fDay.Inclusions))
						{
							@foreach (var i in fDay.Inclusions.Split(';'))
							{
								<li>@i</li>
							}
						}
					</ul>
				</div>
				<div class="col-md-6">
					<span class="fw-bold text-danger small">✕ EXCLUSIONS</span>
					<ul class="list-unstyled small mt-2 mb-0 text-muted">
						@if (fDay != null && !string.IsNullOrEmpty(fDay.Exclusions))
						{
							@foreach (var e in fDay.Exclusions.Split(';'))
							{
								<li>@e</li>
							}
						}
					</ul>
				</div>
			</div>
		</div>

		<div class="col-lg-4">
			<div class="booking-sidebar-compact">
				<h6 class="fw-bold mb-3">Book This Package</h6>
				<form asp-action="Create" asp-controller="Bookings" method="post">
					<input type="hidden" name="PackageId" value="@Model.PackageId" />

					<span class="compact-label">Travel Date</span>
					<input type="date" id="tDate" name="TravelDate" class="form-control compact-input shadow-none" required>

					<span class="compact-label">Number of Guests</span>
					<input type="number" id="gCount" name="Guests" class="form-control compact-input shadow-none" value="1" min="1" max="20" required>

					<span class="compact-label">Your Email</span>
					<input type="email" name="ContactEmail" class="form-control compact-input shadow-none" placeholder="mail@example.com" required>

					<span class="compact-label">Phone Number</span>
					<input type="tel" name="ContactPhone" class="form-control compact-input shadow-none" placeholder="+91 00000 00000" required>

					<div class="price-box-ui">
						<div class="d-flex justify-content-between align-items-center">
							<span class="small text-muted fw-bold">Total Payable</span>
							<span class="h5 fw-bold text-primary mb-0" id="liveTotal">₹@Model.Price.ToString("N0")</span>
						</div>
					</div>

					<button type="button" onclick="validateBooking(event)" class="btn btn-primary w-100 fw-bold py-2 shadow-sm" style="border-radius: 8px;">
						CONFIRM BOOKING
					</button>
				</form>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<script>
		function swap(el) {
			const mainDisplay = document.getElementById('mainDisplay');
			if (mainDisplay && el) {
				mainDisplay.src = el.src;
				document.querySelectorAll('.thumb-nail').forEach(t => t.classList.remove('active'));
				el.classList.add('active');
			}
		}

		document.addEventListener('DOMContentLoaded', function () {
			const basePrice = @(Model?.Price ?? 0);
			const guestInput = document.getElementById('gCount');
			const totalDisplay = document.getElementById('liveTotal');
			const travelDateInput = document.getElementById('tDate');

			if (travelDateInput) {
				const today = new Date().toISOString().split('T')[0];
				travelDateInput.min = today;
			}

			function updatePrice() {
				if (!guestInput || !totalDisplay) return;
				let count = parseInt(guestInput.value) || 1;
				if (count < 1) { count = 1; guestInput.value = 1; }
				if (count > 20) { count = 20; guestInput.value = 20; }
				const total = basePrice * count;
				totalDisplay.innerText = '₹' + total.toLocaleString('en-IN');

				// Keep price updated in storage
				localStorage.setItem('selectedPackagePrice', totalDisplay.innerText);
				localStorage.setItem('totalGuests', count);
			}

			if (guestInput) {
				guestInput.addEventListener('input', updatePrice);
				guestInput.addEventListener('change', updatePrice);
			}

			updatePrice();
		});

		function validateBooking(event) {
			const isLoggedIn = '@(Context.Session.GetString("UserName") != null)' === 'True';

			if (!isLoggedIn) {
				const currentUrl = window.location.pathname;
				alert("Please login or create an account to proceed with your booking.");
				window.location.href = '/Home/Auth?returnUrl=' + encodeURIComponent(currentUrl);
				return;
			}

			const form = event.target.closest('form');
			if (form.checkValidity()) {
				// FIX: Save package name IMMEDIATELY before submission
				localStorage.setItem('selectedPackageName', "@Model.PackageName");
				form.submit();
			} else {
				form.reportValidity();
			}
		}
	</script>
}