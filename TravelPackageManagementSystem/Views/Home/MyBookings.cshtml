@using System.Linq
@using System.Collections.Generic

@model IEnumerable<TravelPackageManagementSystem.Repository.Models.Booking>

@{
    Layout = "_Layout";
    ViewData["Title"] = "My Bookings";
}

@* External CSS Links *@
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    body {
        background-color: #f8f9fa;
    }

    .bg-success-subtle {
        background-color: #e6fffa !important;
        color: #008767 !important;
    }

    .bg-warning-subtle {
        background-color: #fffaf0 !important;
        color: #9c6d19 !important;
    }

    /* Filtering Button Styles */
    .filter-btn.active {
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }

    @@media print {
        body {
            background: white !important;
        }

        .no-print {
            display: none !important;
        }
    }
</style>

<div class="container py-5 no-print">
    <div class="row mb-4 align-items-end">
        <div class="col-md-6">
            <h2 class="fw-bold text-dark">My Bookings</h2>
            <p class="text-muted">Manage your upcoming trips and view your travel history.</p>
        </div>
        <div class="col-md-6 text-md-end">
            @* Integrated Functional Filters *@
            <div class="btn-group shadow-sm" role="group">
                <button type="button" class="btn btn-white border filter-btn active" data-filter="all">All</button>
                <button type="button" class="btn btn-white border filter-btn" data-filter="upcoming">Upcoming</button>
                <button type="button" class="btn btn-white border filter-btn" data-filter="completed">Completed</button>
            </div>
        </div>
    </div>

    @if (Model == null)
    {
        <div class="alert alert-danger shadow-sm border-0 rounded-3 text-center py-5">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h4 class="fw-bold">Connection Error</h4>
            <p>We are having trouble retrieving your booking data.</p>
            <a href="/Home/Index" class="btn btn-danger mt-2">Return Home</a>
        </div>
    }
    else if (!Model.Any())
    {
        <div class="card border-0 shadow-sm text-center py-5 rounded-4">
            <div class="card-body">
                <i class="fas fa-suitcase-rolling fa-4x text-light mb-4"></i>
                <h4 class="text-dark fw-bold">No Bookings Found</h4>
                <p class="text-muted mb-4">You haven't booked any trips yet.</p>
                <a href="/Home/MeghalayaTD" class="btn btn-primary px-4 py-2 rounded-pill">Find a Destination</a>
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="bookingsTable">
                        <thead class="bg-light">
                            <tr class="text-muted small text-uppercase">
                                <th class="ps-4 py-3">Package</th>
                                <th class="py-3">Dates</th>
                                <th class="py-3">Amount</th>
                                <th class="py-3">Phone</th>
                                <th class="py-3">Status</th>
                                <th class="py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var booking in Model)
                            {
                                @* Added Data Attributes for JavaScript Filtering *@
                                <tr class="booking-row" data-status="@booking.Status.ToString().ToUpper()">
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-3 bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <i class="fas fa-map-marked-alt fa-lg"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-bold">@(booking.TravelPackage?.PackageName ?? "Unknown Package")</h6>
                                                <small class="text-muted">Ref: #BK-@booking.BookingId</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small fw-semibold">@booking.TravelDate.ToString("MMM dd, yyyy")</div>
                                        <small class="text-muted">@booking.Guests Guests</small>
                                    </td>
                                    <td>
                                        <div class="fw-bold text-primary">₹@booking.TotalAmount.ToString("N0")</div>
                                    </td>
                                    <td>
                                        <div class="small">@booking.ContactPhone</div>
                                    </td>
                                    <td>
                                        @{
                                            var statusLabel = booking.Status.ToString();
                                            var badgeClass = statusLabel switch
                                            {
                                                "CONFIRMED" => "bg-success-subtle text-success border-success-subtle",
                                                "PENDING" => "bg-warning-subtle text-warning border-warning-subtle",
                                                "CANCELLED" => "bg-danger-subtle text-danger border-danger-subtle",
                                                "COMPLETED" => "bg-info-subtle text-info border-info-subtle",
                                                _ => "bg-light text-muted"
                                            };
                                        }
                                        <span class="badge @badgeClass border px-3 py-2">
                                            @statusLabel
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary"
                                                onclick="generatePDF({
                                                            packageName: '@(booking.TravelPackage?.PackageName?.Replace("'", "\\'"))',
                                                            userName: '@(booking.User?.Username ?? Context.Session.GetString("UserName") ?? "Valued Customer")',
                                                            ref: 'BK-@booking.BookingId',
                                                            date: '@booking.TravelDate.ToString("dd MMM yyyy")',
                                                            amount: '@booking.TotalAmount.ToString("N0")',
                                                            phone: '@booking.ContactPhone',
                                                            email: '@(string.IsNullOrEmpty(booking.ContactEmail) ? "N/A" : booking.ContactEmail)',
                                                            guests: '@booking.Guests',
                                                            status: '@booking.Status'
                                                        })">
                                            <i class="fas fa-download me-1"></i> Receipt
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@* Hidden Receipt Template *@
<div id="receiptTemplate" style="display: none;">
    <div style="padding: 40px; font-family: sans-serif; border: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #333; padding-bottom: 20px;">
            <div>
                <h1 style="margin: 0; color: #0d6efd;">easy Safar</h1>
                <p style="margin: 5px 0;">Official Booking Receipt</p>
            </div>
            <div style="text-align: right;">
                <h3 id="pdfRef" style="margin: 0;"></h3>
                <p id="pdfDate" style="margin: 5px 0;"></p>
            </div>
        </div>
        <div style="margin-top: 30px;">
            <p><strong>Package:</strong> <span id="pdfPackage"></span></p>
            <p><strong>Name:</strong> <span id="pdfName"></span></p>
            <p><strong>Customer Phone:</strong> <span id="pdfPhone"></span></p>
            <p><strong>Customer Email:</strong> <span id="pdfEmail"></span></p>
            <p><strong>Total Guests:</strong> <span id="pdfGuests"></span></p>
            <p><strong>Status:</strong> <span id="pdfStatus" style="color: green; font-weight: bold;"></span></p>
        </div>
        <table style="width: 100%; margin-top: 30px; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Description</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">Travel Package Charges (Inclusive of all taxes)</td>
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;" id="pdfAmount"></td>
                </tr>
            </tbody>
        </table>
        <div style="margin-top: 50px; text-align: center; font-size: 12px; color: #777;">
            <p>Thank you for booking with easy Safar! Wish you a happy journey.</p>
            <p>This is a computer-generated receipt and does not require a signature.</p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        // Tab Filtering Logic
        $(".filter-btn").click(function () {
            $(".filter-btn").removeClass("active");
            $(this).addClass("active");

            const filterValue = $(this).data("filter");

            $(".booking-row").each(function () {
                const status = $(this).data("status");

                if (filterValue === "all") {
                    $(this).show();
                }
                else if (filterValue === "upcoming") {
                    // Show only PENDING or CONFIRMED for upcoming
                    if (status === "PENDING" || status === "CONFIRMED") {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                }
                else if (filterValue === "completed") {
                    // Show only COMPLETED
                    if (status === "COMPLETED") {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                }
            });
        });
    });

    function generatePDF(data) {
        document.getElementById('pdfPackage').innerText = data.packageName;
        document.getElementById('pdfRef').innerText = data.ref;
        document.getElementById('pdfName').innerText = data.userName;
        document.getElementById('pdfDate').innerText = "Travel Date: " + data.date;
        document.getElementById('pdfAmount').innerText = "₹" + data.amount;
        document.getElementById('pdfPhone').innerText = data.phone;
        document.getElementById('pdfEmail').innerText = data.email;
        document.getElementById('pdfGuests').innerText = data.guests;
        document.getElementById('pdfStatus').innerText = data.status;

        const printContents = document.getElementById('receiptTemplate').innerHTML;
        const originalContents = document.body.innerHTML;

        document.body.innerHTML = printContents;
        window.print();
        document.body.innerHTML = originalContents;
        window.location.reload();
    }
</script>